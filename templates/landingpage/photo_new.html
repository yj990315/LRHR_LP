{% extends "base.html" %}
{% block content %}
{% load static %}
<script type="text/javascript">
    $(document).ready(function (e){
      $(".upload-hidden1").change(function(e){
  
        //div 내용 비워주기
        $('#preview1').empty();

        var files = e.target.files;
        var arr =Array.prototype.slice.call(files);
        console.log("check 전")
        console.log(files)
        
        //업로드 가능 파일인지 체크
        //int pre = 1;
        for(var i=0;i<files.length;i++){
          console.log(i+"check")
          if(!checkExtension(files[i].name,files[i].size)){
            //pre = 0;
            arr = []
            return false;
          }
        }

        if (files.length < 2){
          alert("앞 뒤 사진을 포함하여 최소 2장 이상 업로드 해주세요!");
          arr = []
          return false
          //pre = 0;
        }
        console.log("check 후");
        //if(pre==1) 
        preview(arr);
        //else $('#preview').empty();
      });//file change
      
      function checkExtension(fileName,fileSize){
  
        var regex = new RegExp("(.*?)\.(exe|sh|zip|alz|xls|docx|pptx|mp3|mp4)$");
        var maxSize = 20971520;  //20MB
        
        if(fileSize >= maxSize){
          alert('파일 사이즈 초과');
          $("input[type='file']").val("");  //파일 초기화
          return false;
        }
        
        if(regex.test(fileName)){
          alert('업로드 불가능한 파일이 있습니다.');
          $("input[type='file']").val("");  //파일 초기화
          return false;
        }
        return true;
      }
      var imgTarget = $('.preview-image1 .upload-hidden1');
      function preview(arr){
        console.log("preview")
        arr.forEach(function(f){
          
          //파일명이 길면 파일명...으로 처리
          var fileName = f.name;
          if(fileName.length > 10){
            fileName = fileName.substring(0,7)+"...";
          }
          
          //div에 이미지 추가
          var str = '<div style="display: inline-flex; padding-right: 9px; padding-bottom: 9px;"><li>';
          var index = 0;
          //이미지 파일 미리보기
          if(f.type.match('image.*')){
            var reader = new FileReader(); //파일을 읽기 위한 FileReader객체 생성
            reader.onload = function (e) { //파일 읽어들이기를 성공했을때 호출되는 이벤트 핸들러
              //str += '<button type="button" class="delBtn" value="'+f.name+'" style="background: red">x</button><br>';
              str += '<img src="'+e.target.result+'" title="'+f.name+'" style="width:70px; height:66px; border-radius: 10px;"" />';
              index++;
              str += '</li></div>';
              $(str).appendTo('#preview1');
            } 
            reader.readAsDataURL(f);
          } else{
            str += '<img src="/resources/img/fileImg.png" title="'+f.name+'" width=70 height=66 />';
            $(str).appendTo('#preview1');
          }
        });//arr.forEach
      }
    
      $(".upload-hidden2").change(function(e){
  
        //div 내용 비워주기
        $('#preview2').empty();
  
        var files = e.target.files;
        var arr =Array.prototype.slice.call(files);
        
        //업로드 가능 파일인지 체크
        for(var i=0;i<files.length;i++){
          if(!checkExtension(files[i].name,files[i].size)){
            arr = []
            return false;
          }
        }
        
        if (files.length < 2){
          alert("작업부위와 상세사진을 포함한 최소 2장의 사진을 업로드해주세요")
          arr = []
          return false
        }

        preview2(arr);
      });//file change
      
      
      var imgTarget = $('.preview-image2 .upload-hidden2');
      function preview2(arr){
        arr.forEach(function(f){
          
          //파일명이 길면 파일명...으로 처리
          var fileName = f.name;
          if(fileName.length > 10){
            fileName = fileName.substring(0,7)+"...";
          }
          
          //div에 이미지 추가
          var str = '<div style="display: inline-flex; padding-right: 9px; padding-bottom: 9px;"><li>';
          
          //이미지 파일 미리보기
          if(f.type.match('image.*')){
            var reader = new FileReader(); //파일을 읽기 위한 FileReader객체 생성
            reader.onload = function (e) { //파일 읽어들이기를 성공했을때 호출되는 이벤트 핸들러
              //str += '<button type="button" class="delBtn" value="'+f.name+'" style="background: red">x</button><br>';
              str += '<img src="'+e.target.result+'" title="'+f.name+'" style="width:70px; height:66px; border-radius: 10px;"" />';
              str += '</li></div>';
              $(str).appendTo('#preview2');
            } 
            reader.readAsDataURL(f);
          } else{
            str += '<img src="/resources/img/fileImg.png" title="'+f.name+'" width=70 height=66 />';
            $(str).appendTo('#preview2');
          }
        });//arr.forEach
      }
    });
</script>

<link rel="stylesheet" href="{%static 'photo.css'%}">
<link rel="stylesheet" href="{%static 'purpose.css'%}">
<div class="status-bar-bg">
  <div class="status-bar" style="width: 60vw;"></div>
</div>
<button onclick="history.back()" class="back-button"></button>
<div class="title">보여주세요!</div>
<form method="POST" action="{% url 'landingpage:photo_new' estimate_id%}" enctype="multipart/form-data">    {% csrf_token %}
  <div class="overall-img-title">
      전체 샷 (앞 뒤 사진 포함)
  </div>
  <div class="filebox1 bs3-primary preview-image1">
      <label for="overall-img"></label> 
      <input type="file" name="overall-img" id="overall-img" class="upload-hidden1" multiple required>
      <div id="preview1"> </div>
  </div>
  <div class="detail-img-title">
      원하는 작업 부위 (작업 부위와 확대 사진 포함)
  </div>
  <div class="filebox2 bs3-primary preview-image2">
      <label for="detail-img"> </label>
      <input type="file" name="detail-img" id="detail-img" class="upload-hidden2" multiple required>
      <div id="preview2"> </div>
  </div>
  </table>
  <div class="photo-comment">
    * 정확한 단가 측정을 위해 맡기실 상품의 <br>
    <b>전체 샷</b>과 <b>원하는 작업 부위</b> 사진은 <b>필수</b>입니다.
  </div>
  <div id="spinner">
  <div id="floatingCirclesG">
    
    <div class="f_circleG" id="frotateG_01"></div>
    <div class="f_circleG" id="frotateG_02"></div>
    <div class="f_circleG" id="frotateG_03"></div>
    <div class="f_circleG" id="frotateG_04"></div>
    <div class="f_circleG" id="frotateG_05"></div>
    <div class="f_circleG" id="frotateG_06"></div>
    <div class="f_circleG" id="frotateG_07"></div>
    <div class="f_circleG" id="frotateG_08"></div>
    
  </div>
  </div>
  <div id="fixed-next-button">
    <button type="submit" class="save btn btn-default" id="next-button" style="padding-top: 0px" onclick="setSpinner()">
        <span class="fixed_request_button_content"> 다음으로 </span>
    </button>
  </div>
</form>
<script src="/static/loading.js"></script>
{% endblock %}

